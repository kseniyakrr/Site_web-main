{% extends 'base.html' %}

{% block content %}

<div class="pizza-detail">
    <h1>{{ pizza.name }}</h1>
    
    {% if pizza.image %}
    <div class="pizza-image" style="width: 300px; height: 300px; overflow: hidden; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <img src="{{ pizza.image.url }}" alt="{{ pizza.name }}" 
             style="width: 100%; height: 100%; object-fit: cover; object-position: center;">
    </div>
    {% endif %}
    
    <div class="pizza-info">
        <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ pizza.description }}</p>
        <p><strong>–¶–µ–Ω–∞:</strong> {{ pizza.price }} —Ä—É–±.</p>
        <p><strong>–î–∏–∞–º–µ—Ç—Ä:</strong> {{ pizza.diameter }} —Å–º</p>
        <p><strong>–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:</strong> {% if pizza.is_available %}–í –Ω–∞–ª–∏—á–∏–∏{% else %}–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏{% endif %}</p>
        <p><strong>–ò—Å—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∏—è:</strong> {{ pizza.history_text }}</p>
        <!-- –ë–ª–æ–∫ —Å —Ç–µ–≥–∞–º–∏ –ø–∏—Ü—Ü—ã -->
        {% with pizza.tags.all as pizza_tags %}
        {% if pizza_tags %}
        <div class="pizza-tags">
            <p><strong>–¢–µ–≥–∏:</strong></p>
            <ul class="tags-list">
                {% for tag in pizza_tags %}
                <li>
                    <a href="{% url 'tag' tag.slug %}" class="tag">
                        {{ tag.tag }}
                    </a>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
        {% endwith %}
    </div>
   {% if perms.women.change_women %}
<div style="margin-bottom: 20px;">
    <a href="{% url 'edit' pizza.slug %}" class="edit-btn" 
       style="display: inline-block; padding: 8px 15px; 
              background-color: #3498db; color: white; 
              text-decoration: none; border-radius: 4px;
              font-size: 14px;">
        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
    </a>
</div>

{% endif %}
    <a href="{% url 'homepage' %}" class="btn btn-primary">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
    
</div>
<div class="rating-section">
    <button class="like-btn {% if user in pizza.likes.all %}active{% endif %}" 
            id="likeBtn" 
            data-url="{% url 'like_pizza' pizza.slug %}">
        üëç <span id="likeCount">{{ pizza.likes.count }}</span>
    </button>
    <button class="dislike-btn {% if user in pizza.dislikes.all %}active{% endif %}" 
            id="dislikeBtn" 
            data-url="{% url 'dislike_pizza' pizza.slug %}">
        üëé <span id="dislikeCount">{{ pizza.dislikes.count }}</span>
    </button>
</div>
 
     <!-- –°–µ–∫—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
    <div class="comments-section">
        <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
        
        {% if user.is_authenticated %}
        <div class="comment-form">
            <form id="commentForm">
                {% csrf_token %}
                <textarea name="text" id="commentText" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required></textarea>
                <button type="submit" class="btn-comment">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
            <div id="commentError" class="error-message"></div>
        </div>
        {% else %}
        <p class="auth-notice">–ß—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, <a href="{% url 'login' %}">–≤–æ–π–¥–∏—Ç–µ</a> –∏–ª–∏ <a href="{% url 'register' %}">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a>.</p>
        {% endif %}
        
       <div class="comments-list" id="commentsList">
    {% for comment in pizza.comments.all %}
    <div class="comment" id="comment-{{ comment.id }}">
        <div class="comment-header">
            <div>
                <span class="comment-author">{{ comment.author.username }}</span>
                <span class="comment-date">{{ comment.created_at|date:"d.m.Y H:i" }}</span>
            </div>
            {% if user == comment.author or user.is_superuser %}
            <button class="delete-comment-btn" data-comment-id="{{ comment.id }}" 
                    title="–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
                    
                √ó
            </button>
            {% endif %}
        </div>
        <div class="comment-text">{{ comment.text }}</div>
    </div>
    {% empty %}
    <p class="no-comments">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>
    {% endfor %}
</div>
    </div>
<style>
    .pizza-detail-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }

    .pizza-main {
        display: flex;
        gap: 30px;
        align-items: flex-start;
    }

    .pizza-image {
        width: 10px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–∞—Ä—Ç–∏–Ω–∫–∏ */
        height: auto;
        border-radius: 8px;
        object-fit: cover;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .pizza-info {
        flex: 1;
    }

    .pizza-info h1 {
        color: #e67e22;
        margin-top: 0;
        font-size: 28px;
    }

    .description {
        color: #555;
        line-height: 1.6;
        font-size: 16px;
    }

    .price {
        font-size: 24px;
        font-weight: bold;
        color: #d35400;
        margin: 15px 0;
    }

    .order-button {
        background-color: #e67e22;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 4px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .order-button:hover {
        background-color: #d35400;
    }

    @media (max-width: 768px) {
        .pizza-main {
            flex-direction: column;
        }
        
        .pizza-image {
            width: 20%;
            max-width: 350px;
            margin: 0 auto;
        }
    }
</style>

<style>
    .rating-section {
        margin: 20px 0;
        display: flex;
        gap: 15px;
    }
    
    .like-btn, .dislike-btn {
        padding: 8px 15px;
        border: 2px solid #ddd;
        border-radius: 20px;
        background: none;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .like-btn.active {
        border-color: #4CAF50;
        background-color: #e8f5e9;
    }
    
    .dislike-btn.active {
        border-color: #f44336;
        background-color: #ffebee;
    }
</style>

<script>
    function updateRating(button, countId, active) {
        const countElement = document.getElementById(countId);
        let count = parseInt(countElement.textContent);
        count = active ? count + 1 : count - 1;
        countElement.textContent = Math.max(count, 0);
        button.classList.toggle('active', active);
    }

    function handleRating(url, button, otherButton, countId) {
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            updateRating(button, countId, data[Object.keys(data)[0]]);
            if (otherButton.classList.contains('active')) {
                updateRating(otherButton, 
                            otherButton.querySelector('span').id, 
                            false);
            }
        });
    }

    document.getElementById('likeBtn').addEventListener('click', function() {
        handleRating(
            this.dataset.url, 
            this, 
            document.getElementById('dislikeBtn'), 
            'likeCount'
        );
    });

    document.getElementById('dislikeBtn').addEventListener('click', function() {
        handleRating(
            this.dataset.url, 
            this, 
            document.getElementById('likeBtn'), 
            'dislikeCount'
        );
    });
</script>

<style>

.like-container {
  display: flex;
  align-items: center;
}
 
.like-button {
  font-size: 24px;
  border: none;
  background: none;
  cursor: pointer;
  padding: 0;
  margin-right: 8px;
}
 
.like-count {
  font-size: 18px;
}
.delete-comment-btn {
        background: none;
        border: none;
        color: #e74c3c;
        font-size: 1.2em;
        cursor: pointer;
        padding: 0 5px;
        transition: color 0.3s;
    }

    .delete-comment-btn:hover {
        color: #c0392b;
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ */
    .comments-section {
        margin-top: 40px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .comment-form {
        margin-bottom: 20px;
    }

    #commentText {
        width: 100%;
        height: 100px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
    }

    .btn-comment {
        background: #e67e22;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
    }

    .btn-comment:hover {
        background: #d35400;
    }

    .comments-list {
        margin-top: 20px;
    }

    .comment {
        background: white;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.9em;
    }

    .comment-author {
        font-weight: bold;
        color: #2c3e50;
    }

    .comment-date {
        color: #7f8c8d;
    }

    .error-message {
        color: #e74c3c;
        margin-top: 5px;
    }

    .auth-notice {
        background: #fff3cd;
        padding: 10px;
        border-radius: 4px;
        color: #856404;
    }
</style>

<script>
    
document.getElementById('commentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    const errorDiv = document.getElementById('commentError');
    const commentsList = document.getElementById('commentsList');
    
    fetch("{% url 'add_comment' pizza.slug %}", {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            form.reset();
            errorDiv.textContent = '';
            
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment';
            commentDiv.innerHTML = `
                <div class="comment-header">
                    <span class="comment-author">${data.username}</span>
                    <span class="comment-date">${new Date().toLocaleDateString('ru-RU')} ${new Date().toLocaleTimeString('ru-RU').slice(0,5)}</span>
                </div>
                <div class="comment-text">${data.text}</div>
            `;
            
            const noComments = commentsList.querySelector('.no-comments');
            if (noComments) noComments.remove();
            
            commentsList.prepend(commentDiv);
        } else {
            errorDiv.textContent = data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è';
        }
    })
    .catch(error => {
        errorDiv.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
    });
});
</script>
<script>
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
document.querySelectorAll('.delete-comment-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const commentId = this.dataset.commentId;
        const commentElement = document.getElementById(`comment-${commentId}`);
        
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')) {
            fetch(`/comments/${commentId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    commentElement.remove();
                    
                    // –ï—Å–ª–∏ –±–æ–ª—å—à–µ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                    if (!document.querySelectorAll('.comment').length) {
                        const noComments = document.createElement('p');
                        noComments.className = 'no-comments';
                        noComments.textContent = '–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤';
                        document.getElementById('commentsList').appendChild(noComments);
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            });
        }
    });
});
</script>
{% endblock %}